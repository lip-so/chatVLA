# USB Port Detection for LeRobot Arms

This guide explains how to use the USB port detection feature to identify the ports associated with your robotic arms.

## Overview

The USB Port Detection tool helps you identify which USB ports are connected to your leader and follower robotic arms through an interactive, step-by-step process.

## Available Methods

### 1. Web Interface (Recommended)

**Start the application:**
```bash
python run.py
```

**Access port detection:**
- Open your browser to `http://127.0.0.1:5000`
- Click "USB Port Detection" in the footer
- Or navigate directly to `http://127.0.0.1:5000/port-detection.html`

### 2. Command Line Interface

**Run the standalone script:**
```bash
python lerobot/find_port.py
```

## Web Interface Instructions

### Step 1: Initial Setup
1. **Connect Both Arms** - Ensure both leader and follower arms are connected via USB
2. **Check System Status** - Verify that both Git and Conda are detected
3. **Review Available Ports** - See all currently connected serial devices

### Step 2: Interactive Detection Process

**Leader Arm Detection:**
1. Click "Start Detection" 
2. Follow the modal instructions to **unplug the leader arm**
3. Wait for the system to detect the disconnection
4. **Reconnect the leader arm** when prompted
5. System identifies and saves the leader port

**Follower Arm Detection:**
1. Follow instructions to **unplug the follower arm**
2. Wait for disconnection detection
3. **Reconnect the follower arm** when prompted
4. System identifies and saves the follower port

### Step 3: Save Configuration
- Ports are automatically saved to `lerobot_ports.py`
- Configuration can be used in your LeRobot applications
- Results displayed with clear visual indicators

## Features

### Modern Interactive Interface
- **Step-by-step guidance** with visual progress indicators
- **Real-time port monitoring** with automatic detection
- **Clear instructions** with modal dialogs and countdown timers
- **Error handling** with helpful suggestions

### Smart Detection
- **Automatic port enumeration** using pyserial
- **Change detection** by monitoring connect/disconnect events
- **Port validation** to ensure different ports for each arm
- **Configuration persistence** for future use

### User Experience
- **Responsive design** works on desktop, tablet, and mobile
- **Visual feedback** with icons, colors, and animations
- **Skip options** for advanced users
- **Restart capability** to redo detection if needed

## Output

### Generated Configuration File
The detection process creates `lerobot_ports.py`:

```python
# LeRobot Port Configuration
# Generated by USB Port Detection Tool

LEADER_ARM_PORT = "/dev/cu.usbmodem14201"
FOLLOWER_ARM_PORT = "/dev/cu.usbmodem14301"

# Port Details:
# Leader Arm:  /dev/cu.usbmodem14201
# Follower Arm: /dev/cu.usbmodem14301
```

### Using Detected Ports
In your LeRobot applications:

```python
from lerobot_ports import LEADER_ARM_PORT, FOLLOWER_ARM_PORT
import serial

# Connect to leader arm
leader_connection = serial.Serial(LEADER_ARM_PORT, baudrate=9600)

# Connect to follower arm  
follower_connection = serial.Serial(FOLLOWER_ARM_PORT, baudrate=9600)
```

## Troubleshooting

### No Ports Detected
- **Check Connections** - Ensure both arms are connected via USB
- **Install pyserial** - Run `pip install pyserial`
- **Check Drivers** - Ensure USB drivers are installed
- **Try Different USB Ports** - Some ports may not work properly

### Port Detection Fails
- **Wait Longer** - Give the system time to detect changes (3-5 seconds)
- **Try Different Order** - Disconnect arms in different sequence
- **Check USB Cables** - Ensure cables are working properly
- **Restart Application** - Close and restart the detection tool

### Permission Issues
- **macOS/Linux** - You may need appropriate permissions for serial ports
- **Windows** - Run as administrator if needed
- **Port Access** - Ensure no other applications are using the ports

### Web Interface Issues
- **Port 5000 Busy** - Another application may be using port 5000
- **Browser Cache** - Clear browser cache and reload
- **JavaScript Disabled** - Enable JavaScript in your browser
- **WebSocket Connection** - Check if WebSocket connections are blocked

## Command Line Alternative

If you prefer the command line interface:

```bash
cd /Users/darynah/application
python lerobot/find_port.py
```

**Command Line Features:**
- Text-based interface with clear instructions
- Same detection logic as web interface
- Detailed logging and error messages
- Automatic configuration file generation

**Command Line Process:**
1. Shows all available ports initially
2. Prompts to unplug leader arm and press Enter
3. Detects disconnection and prompts to reconnect
4. Repeats process for follower arm
5. Saves configuration and displays results

## Advanced Usage

### API Endpoints
For custom integration:

- `GET /api/list-ports` - List available serial ports
- `POST /api/detect-port-changes` - Detect port changes
- `POST /api/save-port-config` - Save port configuration

### WebSocket Events
Real-time updates via WebSocket:

- `port_list_update` - Port list changed
- `port_change_detected` - Port connected/disconnected
- `port_config_saved` - Configuration saved successfully

### Custom Integration
You can integrate the port detection logic into your own applications:

```python
from backend.app import PortDetectionManager

detector = PortDetectionManager()
ports = detector.get_available_ports()
changes = detector.detect_port_changes(['previous', 'ports'])
detector.save_port_configuration('/dev/tty1', '/dev/tty2')
```

## System Requirements

- **Python 3.7+** with pyserial library
- **USB connections** for both robotic arms
- **Web browser** (Chrome, Firefox, Safari, Edge)
- **Operating System** - Windows, macOS, or Linux

## Support

For issues with port detection:

1. **Check Prerequisites** - Ensure pyserial is installed and arms are connected
2. **Review Logs** - Check console output for error messages  
3. **Try Both Interfaces** - Web interface and command line
4. **Restart System** - Sometimes USB subsystem needs reset
5. **Manual Configuration** - Create `lerobot_ports.py` manually if needed

The port detection tool is designed to make identifying robotic arm ports as simple and reliable as possible.